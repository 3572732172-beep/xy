{"version":3,"file":"baidu-speech.js","sources":["utils/baidu-speech.js"],"sourcesContent":["/**\n * 百度语音识别工具\n * 支持方言识别\n */\n\n// 百度语音服务配置（请替换为实际配置）\nconst BAIDU_SPEECH_CONFIG = {\n\tAPP_ID: '121196899', // 请填入您的百度 APP ID\n\tAPI_KEY: 'XLNF1v5ozxh4NPz93Iv0YLfL', // 请填入您的 API Key\n\tSECRET_KEY: 'OhDuVGpc92vh6H7zZsS3Zjmr9oSpW2O5' // 请填入您的 Secret Key\n};\n\n// 方言识别语言代码\nconst LANGUAGE_CODES = {\n\t普通话: '1537', // 普通话\n\t四川话: '1837', // 四川话\n\t粤语: '1637', // 粤语\n\t上海话: '1737', // 上海话\n\t闽南语: '1937', // 闽南语\n\t东北话: '2037', // 东北话\n\t河南话: '2137', // 河南话\n\t山东话: '2237', // 山东话\n\t陕西话: '2337', // 陕西话\n\t湖北话: '2437', // 湖北话\n\t湖南话: '2537', // 湖南话\n\t江西话: '2637', // 江西话\n\t安徽话: '2737' // 安徽话\n};\n\n/**\n * 获取百度 Access Token\n */\nasync function getAccessToken() {\n\tconst tokenKey = 'baidu_speech_token';\n\tconst tokenExpireKey = 'baidu_speech_token_expire';\n\t\n\t// 检查缓存的 token 是否有效\n\tconst cachedToken = uni.getStorageSync(tokenKey);\n\tconst expireTime = uni.getStorageSync(tokenExpireKey);\n\t\n\tif (cachedToken && expireTime && Date.now() < expireTime) {\n\t\treturn cachedToken;\n\t}\n\t\n\ttry {\n\t\tconst url = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU_SPEECH_CONFIG.API_KEY}&client_secret=${BAIDU_SPEECH_CONFIG.SECRET_KEY}`;\n\t\t\n\t\tconst res = await uni.request({\n\t\t\turl: url,\n\t\t\tmethod: 'POST',\n\t\t\theader: {\n\t\t\t\t'Content-Type': 'application/json'\n\t\t\t}\n\t\t});\n\t\t\n\t\tif (res.data && res.data.access_token) {\n\t\t\tconst token = res.data.access_token;\n\t\t\tconst expiresIn = res.data.expires_in || 2592000; // 默认30天\n\t\t\t\n\t\t\t// 缓存 token（提前5分钟过期）\n\t\t\tuni.setStorageSync(tokenKey, token);\n\t\t\tuni.setStorageSync(tokenExpireKey, Date.now() + (expiresIn - 300) * 1000);\n\t\t\t\n\t\t\treturn token;\n\t\t} else {\n\t\t\tthrow new Error('获取 Access Token 失败');\n\t\t}\n\t} catch (error) {\n\t\tconsole.error('获取百度 Access Token 失败:', error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * 将语音文件转换为 Base64\n */\nfunction fileToBase64(filePath) {\n\treturn new Promise((resolve, reject) => {\n\t\t// #ifdef MP-WEIXIN\n\t\tconst fs = wx.getFileSystemManager();\n\t\tfs.readFile({\n\t\t\tfilePath: filePath,\n\t\t\tencoding: 'base64',\n\t\t\tsuccess: (res) => {\n\t\t\t\tresolve(res.data);\n\t\t\t},\n\t\t\tfail: reject\n\t\t});\n\t\t// #endif\n\t\t\n\t\t// #ifdef H5\n\t\t// H5 环境需要先上传文件，然后转换为 base64\n\t\tuni.uploadFile({\n\t\t\turl: filePath,\n\t\t\tsuccess: (res) => {\n\t\t\t\tresolve(res.data);\n\t\t\t},\n\t\t\tfail: reject\n\t\t});\n\t\t// #endif\n\t\t\n\t\t// #ifdef APP-PLUS\n\t\tplus.io.resolveLocalFileSystemURL(filePath, (entry) => {\n\t\t\tentry.file((file) => {\n\t\t\t\tconst reader = new FileReader();\n\t\t\t\treader.onload = (e) => {\n\t\t\t\t\tconst base64 = e.target.result.split(',')[1];\n\t\t\t\t\tresolve(base64);\n\t\t\t\t};\n\t\t\t\treader.onerror = reject;\n\t\t\t\treader.readAsDataURL(file);\n\t\t\t});\n\t\t});\n\t\t// #endif\n\t});\n}\n\n/**\n * 语音识别\n * @param {String} audioPath 音频文件路径\n * @param {String} language 语言类型（默认普通话）\n * @returns {Promise<String>} 识别结果文本\n */\nasync function recognizeSpeech(audioPath, language = '普通话') {\n\ttry {\n\t\t// 检查配置\n\t\tif (!BAIDU_SPEECH_CONFIG.APP_ID || !BAIDU_SPEECH_CONFIG.API_KEY || !BAIDU_SPEECH_CONFIG.SECRET_KEY) {\n\t\t\tthrow new Error('请先配置百度语音服务参数');\n\t\t}\n\t\t\n\t\t// 获取 Access Token\n\t\tconst accessToken = await getAccessToken();\n\t\t\n\t\t// 获取语言代码\n\t\tconst languageCode = LANGUAGE_CODES[language] || LANGUAGE_CODES['普通话'];\n\t\t\n\t\t// 调用百度语音识别 API\n\t\tconst url = `https://vop.baidu.com/server_api?dev_pid=${languageCode}&cuid=${BAIDU_SPEECH_CONFIG.APP_ID}&token=${accessToken}`;\n\t\t\n\t\t// 读取音频文件（百度语音识别需要原始 PCM 数据）\n\t\t// #ifdef MP-WEIXIN\n\t\tconst fs = wx.getFileSystemManager();\n\t\tlet audioData;\n\t\ttry {\n\t\t\taudioData = fs.readFileSync(audioPath, 'binary');\n\t\t\tconsole.log('音频文件大小:', audioData ? audioData.length : 0, '字节');\n\t\t\t\n\t\t\t// 检查音频文件大小（至少需要1KB）\n\t\t\tif (!audioData || audioData.length < 1024) {\n\t\t\t\tthrow new Error('音频文件太小，请至少录音2秒以上');\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error('读取音频文件失败:', e);\n\t\t\tthrow new Error('读取音频文件失败: ' + e.message);\n\t\t}\n\t\t\n\t\tconst res = await uni.request({\n\t\t\turl: url,\n\t\t\tmethod: 'POST',\n\t\t\theader: {\n\t\t\t\t'Content-Type': 'audio/pcm;rate=16000'\n\t\t\t},\n\t\t\tdata: audioData\n\t\t});\n\t\t// #endif\n\t\t\n\t\t// #ifndef MP-WEIXIN\n\t\t// 其他平台需要先读取文件\n\t\tconst audioBase64 = await fileToBase64(audioPath);\n\t\t// 将 base64 转换为 ArrayBuffer\n\t\tconst binaryString = atob(audioBase64);\n\t\tconst bytes = new Uint8Array(binaryString.length);\n\t\tfor (let i = 0; i < binaryString.length; i++) {\n\t\t\tbytes[i] = binaryString.charCodeAt(i);\n\t\t}\n\t\tconst res = await uni.request({\n\t\t\turl: url,\n\t\t\tmethod: 'POST',\n\t\t\theader: {\n\t\t\t\t'Content-Type': 'audio/pcm;rate=16000'\n\t\t\t},\n\t\t\tdata: bytes.buffer\n\t\t});\n\t\t// #endif\n\t\t\n\t\t// 解析响应\n\t\tlet responseData;\n\t\tif (typeof res.data === 'string') {\n\t\t\ttry {\n\t\t\t\tresponseData = JSON.parse(res.data);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('解析响应失败:', res.data);\n\t\t\t\tthrow new Error('响应解析失败: ' + res.data.substring(0, 100));\n\t\t\t}\n\t\t} else if (res.data && typeof res.data === 'object') {\n\t\t\tresponseData = res.data;\n\t\t} else {\n\t\t\tconsole.error('响应格式错误:', res);\n\t\t\tthrow new Error('响应格式错误');\n\t\t}\n\t\t\n\t\tconsole.log('百度API响应:', responseData);\n\t\t\n\t\t// 检查错误码\n\t\tif (responseData.err_no !== undefined && responseData.err_no !== 0) {\n\t\t\tconst errorMsg = responseData.err_msg || '识别失败';\n\t\t\tconst errorCode = responseData.err_no;\n\t\t\tconsole.error('百度API错误:', errorCode, errorMsg);\n\t\t\tthrow new Error(`识别失败 (错误码: ${errorCode}): ${errorMsg}`);\n\t\t}\n\t\t\n\t\tif (responseData && responseData.result && responseData.result.length > 0) {\n\t\t\treturn responseData.result[0];\n\t\t} else {\n\t\t\tconst errorMsg = responseData.err_msg || '识别失败，未返回结果';\n\t\t\tconsole.error('识别失败:', responseData);\n\t\t\tthrow new Error(errorMsg);\n\t\t}\n\t} catch (error) {\n\t\tconsole.error('语音识别失败:', error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * 开始录音\n * @param {Object} options 录音选项\n * @returns {Promise<Object>} 录音管理器\n */\nfunction startRecord(options = {}) {\n\treturn new Promise((resolve, reject) => {\n\t\tconst recorderManager = uni.getRecorderManager();\n\t\t\n\t\trecorderManager.onStart(() => {\n\t\t\tconsole.log('开始录音');\n\t\t});\n\t\t\n\t\trecorderManager.onError((err) => {\n\t\t\tconsole.error('录音错误:', err);\n\t\t\treject(err);\n\t\t});\n\t\t\n\t\t// 录音参数\n\t\tconst recordOptions = {\n\t\t\tduration: options.duration || 60000, // 最长60秒\n\t\t\tsampleRate: 16000, // 采样率\n\t\t\tnumberOfChannels: 1, // 录音通道数\n\t\t\tencodeBitRate: 96000, // 编码码率\n\t\t\tformat: 'pcm', // 音频格式（百度语音识别支持 pcm）\n\t\t\tframeSize: 50, // 指定帧大小\n\t\t\t...options\n\t\t};\n\t\t\n\t\trecorderManager.start(recordOptions);\n\t\tresolve(recorderManager);\n\t});\n}\n\n/**\n * 停止录音并返回文件路径\n * @param {Object} recorderManager 录音管理器\n * @returns {Promise<String>} 录音文件路径\n */\nfunction stopRecord(recorderManager) {\n\treturn new Promise((resolve, reject) => {\n\t\trecorderManager.onStop((res) => {\n\t\t\tconsole.log('录音结束:', res);\n\t\t\tresolve(res.tempFilePath);\n\t\t});\n\t\t\n\t\trecorderManager.onError((err) => {\n\t\t\treject(err);\n\t\t});\n\t\t\n\t\trecorderManager.stop();\n\t});\n}\n\n/**\n * 录音并识别（完整流程）\n * @param {String} language 语言类型\n * @param {Function} onProgress 进度回调\n * @returns {Promise<String>} 识别结果\n */\nasync function recordAndRecognize(language = '普通话', onProgress) {\n\ttry {\n\t\t// 开始录音\n\t\tif (onProgress) onProgress('开始录音...');\n\t\tconst recorderManager = await startRecord();\n\t\t\n\t\t// 等待用户停止录音（这里需要外部控制）\n\t\t// 返回录音管理器，由调用方控制停止\n\t\treturn recorderManager;\n\t} catch (error) {\n\t\tconsole.error('录音失败:', error);\n\t\tthrow error;\n\t}\n}\n\nexport default {\n\trecognizeSpeech,\n\tstartRecord,\n\tstopRecord,\n\trecordAndRecognize,\n\tLANGUAGE_CODES,\n\tsetConfig(config) {\n\t\tObject.assign(BAIDU_SPEECH_CONFIG, config);\n\t},\n\tgetConfig() {\n\t\treturn BAIDU_SPEECH_CONFIG;\n\t},\n\thasConfig() {\n\t\treturn !!(BAIDU_SPEECH_CONFIG.APP_ID && BAIDU_SPEECH_CONFIG.API_KEY && BAIDU_SPEECH_CONFIG.SECRET_KEY);\n\t}\n};\n\n"],"names":["uni","wx"],"mappings":";;AAMA,MAAM,sBAAsB;AAAA,EAC3B,QAAQ;AAAA;AAAA,EACR,SAAS;AAAA;AAAA,EACT,YAAY;AAAA;AACb;AAGA,MAAM,iBAAiB;AAAA,EACtB,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,IAAI;AAAA;AAAA,EACJ,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AAAA,EACL,KAAK;AAAA;AACN;AAKA,eAAe,iBAAiB;AAC/B,QAAM,WAAW;AACjB,QAAM,iBAAiB;AAGvB,QAAM,cAAcA,cAAAA,MAAI,eAAe,QAAQ;AAC/C,QAAM,aAAaA,cAAAA,MAAI,eAAe,cAAc;AAEpD,MAAI,eAAe,cAAc,KAAK,IAAG,IAAK,YAAY;AACzD,WAAO;AAAA,EACP;AAED,MAAI;AACH,UAAM,MAAM,oFAAoF,oBAAoB,OAAO,kBAAkB,oBAAoB,UAAU;AAE3K,UAAM,MAAM,MAAMA,cAAG,MAAC,QAAQ;AAAA,MAC7B;AAAA,MACA,QAAQ;AAAA,MACR,QAAQ;AAAA,QACP,gBAAgB;AAAA,MAChB;AAAA,IACJ,CAAG;AAED,QAAI,IAAI,QAAQ,IAAI,KAAK,cAAc;AACtC,YAAM,QAAQ,IAAI,KAAK;AACvB,YAAM,YAAY,IAAI,KAAK,cAAc;AAGzCA,oBAAAA,MAAI,eAAe,UAAU,KAAK;AAClCA,0BAAI,eAAe,gBAAgB,KAAK,IAAK,KAAI,YAAY,OAAO,GAAI;AAExE,aAAO;AAAA,IACV,OAAS;AACN,YAAM,IAAI,MAAM,oBAAoB;AAAA,IACpC;AAAA,EACD,SAAQ,OAAO;AACfA,kBAAA,MAAA,MAAA,SAAA,+BAAc,yBAAyB,KAAK;AAC5C,UAAM;AAAA,EACN;AACF;AAoDA,eAAe,gBAAgB,WAAW,WAAW,OAAO;AAC3D,MAAI;AAEH,QAAI,CAAC,oBAAoB,UAAU,CAAC,oBAAoB,WAAW,CAAC,oBAAoB,YAAY;AACnG,YAAM,IAAI,MAAM,cAAc;AAAA,IAC9B;AAGD,UAAM,cAAc,MAAM;AAG1B,UAAM,eAAe,eAAe,QAAQ,KAAK,eAAe,KAAK;AAGrE,UAAM,MAAM,4CAA4C,YAAY,SAAS,oBAAoB,MAAM,UAAU,WAAW;AAI5H,UAAM,KAAKC,mBAAG;AACd,QAAI;AACJ,QAAI;AACH,kBAAY,GAAG,aAAa,WAAW,QAAQ;AAC/CD,oBAAAA,MAAA,MAAA,OAAA,gCAAY,WAAW,YAAY,UAAU,SAAS,GAAG,IAAI;AAG7D,UAAI,CAAC,aAAa,UAAU,SAAS,MAAM;AAC1C,cAAM,IAAI,MAAM,kBAAkB;AAAA,MAClC;AAAA,IACD,SAAQ,GAAG;AACXA,oBAAA,MAAA,MAAA,SAAA,gCAAc,aAAa,CAAC;AAC5B,YAAM,IAAI,MAAM,eAAe,EAAE,OAAO;AAAA,IACxC;AAED,UAAM,MAAM,MAAMA,cAAG,MAAC,QAAQ;AAAA,MAC7B;AAAA,MACA,QAAQ;AAAA,MACR,QAAQ;AAAA,QACP,gBAAgB;AAAA,MAChB;AAAA,MACD,MAAM;AAAA,IACT,CAAG;AAuBD,QAAI;AACJ,QAAI,OAAO,IAAI,SAAS,UAAU;AACjC,UAAI;AACH,uBAAe,KAAK,MAAM,IAAI,IAAI;AAAA,MAClC,SAAQ,GAAG;AACXA,sBAAc,MAAA,MAAA,SAAA,gCAAA,WAAW,IAAI,IAAI;AACjC,cAAM,IAAI,MAAM,aAAa,IAAI,KAAK,UAAU,GAAG,GAAG,CAAC;AAAA,MACvD;AAAA,IACJ,WAAa,IAAI,QAAQ,OAAO,IAAI,SAAS,UAAU;AACpD,qBAAe,IAAI;AAAA,IACtB,OAAS;AACNA,oBAAA,MAAA,MAAA,SAAA,gCAAc,WAAW,GAAG;AAC5B,YAAM,IAAI,MAAM,QAAQ;AAAA,IACxB;AAEDA,kBAAY,MAAA,MAAA,OAAA,gCAAA,YAAY,YAAY;AAGpC,QAAI,aAAa,WAAW,UAAa,aAAa,WAAW,GAAG;AACnE,YAAM,WAAW,aAAa,WAAW;AACzC,YAAM,YAAY,aAAa;AAC/BA,oBAAc,MAAA,MAAA,SAAA,gCAAA,YAAY,WAAW,QAAQ;AAC7C,YAAM,IAAI,MAAM,cAAc,SAAS,MAAM,QAAQ,EAAE;AAAA,IACvD;AAED,QAAI,gBAAgB,aAAa,UAAU,aAAa,OAAO,SAAS,GAAG;AAC1E,aAAO,aAAa,OAAO,CAAC;AAAA,IAC/B,OAAS;AACN,YAAM,WAAW,aAAa,WAAW;AACzCA,oBAAA,MAAA,MAAA,SAAA,gCAAc,SAAS,YAAY;AACnC,YAAM,IAAI,MAAM,QAAQ;AAAA,IACxB;AAAA,EACD,SAAQ,OAAO;AACfA,kBAAc,MAAA,MAAA,SAAA,gCAAA,WAAW,KAAK;AAC9B,UAAM;AAAA,EACN;AACF;AAOA,SAAS,YAAY,UAAU,IAAI;AAClC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvC,UAAM,kBAAkBA,oBAAI;AAE5B,oBAAgB,QAAQ,MAAM;AAC7BA,oBAAAA,MAAA,MAAA,OAAA,gCAAY,MAAM;AAAA,IACrB,CAAG;AAED,oBAAgB,QAAQ,CAAC,QAAQ;AAChCA,oBAAA,MAAA,MAAA,SAAA,gCAAc,SAAS,GAAG;AAC1B,aAAO,GAAG;AAAA,IACb,CAAG;AAGD,UAAM,gBAAgB;AAAA,MACrB,UAAU,QAAQ,YAAY;AAAA;AAAA,MAC9B,YAAY;AAAA;AAAA,MACZ,kBAAkB;AAAA;AAAA,MAClB,eAAe;AAAA;AAAA,MACf,QAAQ;AAAA;AAAA,MACR,WAAW;AAAA;AAAA,MACX,GAAG;AAAA,IACN;AAEE,oBAAgB,MAAM,aAAa;AACnC,YAAQ,eAAe;AAAA,EACzB,CAAE;AACF;AAOA,SAAS,WAAW,iBAAiB;AACpC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvC,oBAAgB,OAAO,CAAC,QAAQ;AAC/BA,oBAAA,MAAA,MAAA,OAAA,gCAAY,SAAS,GAAG;AACxB,cAAQ,IAAI,YAAY;AAAA,IAC3B,CAAG;AAED,oBAAgB,QAAQ,CAAC,QAAQ;AAChC,aAAO,GAAG;AAAA,IACb,CAAG;AAED,oBAAgB,KAAI;AAAA,EACtB,CAAE;AACF;AAQA,eAAe,mBAAmB,WAAW,OAAO,YAAY;AAC/D,MAAI;AAEH,QAAI;AAAY,iBAAW,SAAS;AACpC,UAAM,kBAAkB,MAAM;AAI9B,WAAO;AAAA,EACP,SAAQ,OAAO;AACfA,kBAAc,MAAA,MAAA,SAAA,gCAAA,SAAS,KAAK;AAC5B,UAAM;AAAA,EACN;AACF;AAEA,MAAe,cAAA;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,UAAU,QAAQ;AACjB,WAAO,OAAO,qBAAqB,MAAM;AAAA,EACzC;AAAA,EACD,YAAY;AACX,WAAO;AAAA,EACP;AAAA,EACD,YAAY;AACX,WAAO,CAAC,EAAE,oBAAoB,UAAU,oBAAoB,WAAW,oBAAoB;AAAA,EAC3F;AACF;;"}