{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["/**\n * 统一请求封装\n * 自动注入 token，统一错误处理\n */\n\nimport userStore from '@/store/user.js';\n\n// 小程序环境无 process 对象，这里做兼容\nconst ENV = typeof process !== 'undefined' && process.env ? process.env : {};\n\n// 后端 API 地址配置\n// 可在 .env.development/.env.production 中设置：\n// UNI_APP_BASE_URL, UNI_APP_DEV_BASE_URL, UNI_APP_PROD_BASE_URL\nconst DEFAULT_DEV_URL = ENV.UNI_APP_DEV_BASE_URL || 'http://localhost:3001';\nconst DEFAULT_PROD_URL = ENV.UNI_APP_PROD_BASE_URL || 'http://192.168.109.1:3001';\n\nlet BASE_URL = DEFAULT_DEV_URL;\n\n// #ifdef H5\nBASE_URL = ENV.UNI_APP_BASE_URL || DEFAULT_DEV_URL;\n// #endif\n\n// #ifdef MP-WEIXIN\n// 微信小程序开发环境，默认使用本地服务器\n// 注意：微信小程序中 localhost 可能无法访问，请使用本机IP地址\n// 如果无法访问 localhost，请修改为你的本机IP地址，如：http://192.168.1.100:3000\n// 或者通过环境变量 UNI_APP_BASE_URL 设置\nBASE_URL = ENV.UNI_APP_BASE_URL || DEFAULT_DEV_URL;\n// #endif\n\n// #ifndef H5\n// #ifndef MP-WEIXIN\nBASE_URL = ENV.UNI_APP_BASE_URL || (ENV.NODE_ENV === 'development' ? DEFAULT_DEV_URL : DEFAULT_PROD_URL);\n// #endif\n// #endif\n\n// 导出 BASE_URL 供其他模块使用\nexport { BASE_URL };\n\n// 请求拦截器\nconst requestInterceptor = (config) => {\n\t// 设置默认 header\n\tconfig.header = config.header || {};\n\tconfig.header['Content-Type'] = 'application/json';\n\t\n\t// 从本地存储获取 token\n\tconst token = uni.getStorageSync('token') || '';\n\tif (token) {\n\t\tconfig.header['Authorization'] = `Bearer ${token}`;\n\t}\n\t\n\treturn config;\n};\n\n// 响应拦截器\nconst responseInterceptor = (response) => {\n\tconst { statusCode, data } = response;\n\t\n\t// HTTP 状态码检查\n\tif (statusCode !== 200) {\n\t\t// 不显示 toast，静默处理，让调用方决定是否提示\n\t\tconst errorMsg = `HTTP Error: ${statusCode}`;\n\t\tconsole.error(errorMsg);\n\t\treturn Promise.reject(new Error(errorMsg));\n\t}\n\t\n\t// 业务状态码检查\n\tif (data.code !== 0) {\n\t\t// 仅在明确的权限错误时清除登录，避免误伤\n\t\tif (data.code === 401 || data.code === 403) {\n\t\t\tuni.removeStorageSync('token');\n\t\t\tuni.removeStorageSync('userInfo');\n\t\t\tif (userStore && userStore.clearUserInfo) {\n\t\t\t\tuserStore.clearUserInfo();\n\t\t\t}\n\t\t\tconsole.warn('Token无效或已过期，已清除登录信息');\n\t\t}\n\t\t\n\t\t// 不显示 toast，让调用方决定如何处理错误\n\t\t// 这样可以避免在首页等页面显示错误提示\n\t\t// 减少日志输出，仅在开发环境或特定情况下输出\n\t\tconst errorMsg = data.msg || '请求失败';\n\t\t// 只在非业务逻辑错误时输出详细日志（避免重复输出已知的错误）\n\t\tif (data.code !== 1) {\n\t\t\tconsole.error('API请求失败:', errorMsg);\n\t\t}\n\t\treturn Promise.reject(new Error(errorMsg));\n\t}\n\t\n\treturn data.data;\n};\n\n/**\n * 统一请求方法\n * @param {Object} options 请求配置\n * @returns {Promise}\n */\nconst request = (options) => {\n\treturn new Promise((resolve, reject) => {\n\t\t// 请求拦截\n\t\tconst config = requestInterceptor({\n\t\t\turl: options.url.startsWith('http') ? options.url : BASE_URL + options.url,\n\t\t\tmethod: options.method || 'GET',\n\t\t\tdata: options.data || {},\n\t\t\theader: options.header || {},\n\t\t\ttimeout: options.timeout || 10000\n\t\t});\n\t\t\n\t\t// 发送请求\n\t\tuni.request({\n\t\t\t...config,\n\t\t\tsuccess: (res) => {\n\t\t\t\t// 响应拦截，兼容拦截器返回值或 Promise\n\t\t\t\tPromise.resolve(responseInterceptor(res))\n\t\t\t\t\t.then(resolve)\n\t\t\t\t\t.catch(reject);\n\t\t\t},\n\t\t\tfail: (err) => {\n\t\t\t\t// 网络错误处理 - 静默失败，不显示提示\n\t\t\t\t// 避免在开发环境下输出过多错误信息\n\t\t\t\tconst errorMsg = err.errMsg || '网络请求失败';\n\t\t\t\t// 只在真正的网络错误时输出（排除业务逻辑错误）\n\t\t\t\tif (errorMsg.includes('request:fail') || errorMsg.includes('timeout')) {\n\t\t\t\t\tconsole.error('网络请求失败', errorMsg);\n\t\t\t\t}\n\t\t\t\treject(new Error(errorMsg));\n\t\t\t}\n\t\t});\n\t});\n};\n\n// 便捷方法\nconst get = (url, data = {}) => {\n\treturn request({\n\t\turl,\n\t\tmethod: 'GET',\n\t\tdata\n\t});\n};\n\nconst post = (url, data = {}) => {\n\treturn request({\n\t\turl,\n\t\tmethod: 'POST',\n\t\tdata\n\t});\n};\n\nconst put = (url, data = {}) => {\n\treturn request({\n\t\turl,\n\t\tmethod: 'PUT',\n\t\tdata\n\t});\n};\n\nconst del = (url, data = {}) => {\n\treturn request({\n\t\turl,\n\t\tmethod: 'DELETE',\n\t\tdata\n\t});\n};\n\nexport default {\n\trequest,\n\tget,\n\tpost,\n\tput,\n\tdelete: del\n};\n\n"],"names":["BASE_URL","uni","userStore"],"mappings":"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"}