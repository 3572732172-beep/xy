{"version":3,"file":"offline.js","sources":["utils/offline.js"],"sourcesContent":["/**\n * 离线存储管理\n * 使用 uni.setStorageSync / uni.getStorageSync 实现本地存储\n * 注意：SQLite 需要原生插件支持，这里先用本地存储模拟\n */\n\nconst STORAGE_KEYS = {\n\tDRAFT_DEMANDS: 'draft_demands', // 需求草稿列表\n\tSYNC_QUEUE: 'sync_queue', // 待同步队列\n\tUSER_ADDRESSES: 'user_addresses', // 用户常用地址\n\tRECENT_ORDERS: 'recent_orders' // 最近订单摘要\n};\n\n/**\n * 生成本地 UUID\n */\nconst generateLocalId = () => {\n\treturn 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n};\n\n/**\n * 需求草稿管理\n */\nconst draftDemand = {\n\t/**\n\t * 保存需求草稿\n\t * @param {Object} demandData 需求数据\n\t * @returns {String} 本地草稿 ID\n\t */\n\tsave: (demandData) => {\n\t\tconst localId = demandData.offline_local_id || generateLocalId();\n\t\tconst draft = {\n\t\t\t...demandData,\n\t\t\toffline_local_id: localId,\n\t\t\tcreated_at: Date.now(),\n\t\t\tupdated_at: Date.now()\n\t\t};\n\t\t\n\t\tconst drafts = draftDemand.getAll();\n\t\tconst index = drafts.findIndex(d => d.offline_local_id === localId);\n\t\t\n\t\tif (index >= 0) {\n\t\t\tdrafts[index] = draft;\n\t\t} else {\n\t\t\tdrafts.push(draft);\n\t\t}\n\t\t\n\t\tuni.setStorageSync(STORAGE_KEYS.DRAFT_DEMANDS, drafts);\n\t\treturn localId;\n\t},\n\t\n\t/**\n\t * 获取所有草稿\n\t * @returns {Array}\n\t */\n\tgetAll: () => {\n\t\ttry {\n\t\t\treturn uni.getStorageSync(STORAGE_KEYS.DRAFT_DEMANDS) || [];\n\t\t} catch (e) {\n\t\t\tconsole.error('获取草稿失败', e);\n\t\t\treturn [];\n\t\t}\n\t},\n\t\n\t/**\n\t * 根据 ID 获取草稿\n\t * @param {String} localId 本地草稿 ID\n\t * @returns {Object|null}\n\t */\n\tgetById: (localId) => {\n\t\tconst drafts = draftDemand.getAll();\n\t\treturn drafts.find(d => d.offline_local_id === localId) || null;\n\t},\n\t\n\t/**\n\t * 删除草稿\n\t * @param {String} localId 本地草稿 ID\n\t */\n\tremove: (localId) => {\n\t\tconst drafts = draftDemand.getAll();\n\t\tconst filtered = drafts.filter(d => d.offline_local_id !== localId);\n\t\tuni.setStorageSync(STORAGE_KEYS.DRAFT_DEMANDS, filtered);\n\t},\n\t\n\t/**\n\t * 清空所有草稿\n\t */\n\tclear: () => {\n\t\tuni.removeStorageSync(STORAGE_KEYS.DRAFT_DEMANDS);\n\t}\n};\n\n/**\n * 同步队列管理\n */\nconst syncQueue = {\n\t/**\n\t * 添加到同步队列\n\t * @param {String} localId 本地草稿 ID\n\t * @param {String} type 同步类型：'demand_create' | 'demand_sync'\n\t */\n\tadd: (localId, type = 'demand_create') => {\n\t\tconst queue = syncQueue.getAll();\n\t\tconst exists = queue.find(item => item.local_id === localId);\n\t\t\n\t\tif (!exists) {\n\t\t\tqueue.push({\n\t\t\t\tlocal_id: localId,\n\t\t\t\ttype: type,\n\t\t\t\tcreated_at: Date.now(),\n\t\t\t\tretry_count: 0\n\t\t\t});\n\t\t\tuni.setStorageSync(STORAGE_KEYS.SYNC_QUEUE, queue);\n\t\t}\n\t},\n\t\n\t/**\n\t * 获取所有待同步项\n\t * @returns {Array}\n\t */\n\tgetAll: () => {\n\t\ttry {\n\t\t\treturn uni.getStorageSync(STORAGE_KEYS.SYNC_QUEUE) || [];\n\t\t} catch (e) {\n\t\t\treturn [];\n\t\t}\n\t},\n\t\n\t/**\n\t * 从队列中移除\n\t * @param {String} localId 本地草稿 ID\n\t */\n\tremove: (localId) => {\n\t\tconst queue = syncQueue.getAll();\n\t\tconst filtered = queue.filter(item => item.local_id !== localId);\n\t\tuni.setStorageSync(STORAGE_KEYS.SYNC_QUEUE, filtered);\n\t},\n\t\n\t/**\n\t * 更新重试次数\n\t * @param {String} localId 本地草稿 ID\n\t */\n\tincrementRetry: (localId) => {\n\t\tconst queue = syncQueue.getAll();\n\t\tconst item = queue.find(item => item.local_id === localId);\n\t\tif (item) {\n\t\t\titem.retry_count = (item.retry_count || 0) + 1;\n\t\t\titem.updated_at = Date.now();\n\t\t\tuni.setStorageSync(STORAGE_KEYS.SYNC_QUEUE, queue);\n\t\t}\n\t}\n};\n\n/**\n * 用户地址管理\n */\nconst userAddress = {\n\t/**\n\t * 保存常用地址\n\t * @param {Object} address 地址信息\n\t */\n\tsave: (address) => {\n\t\tconst addresses = userAddress.getAll();\n\t\tconst exists = addresses.find(a => \n\t\t\ta.address === address.address && \n\t\t\ta.lng === address.lng && \n\t\t\ta.lat === address.lat\n\t\t);\n\t\t\n\t\tif (!exists) {\n\t\t\taddresses.unshift({\n\t\t\t\t...address,\n\t\t\t\tcreated_at: Date.now()\n\t\t\t});\n\t\t\t// 最多保存 10 个\n\t\t\tif (addresses.length > 10) {\n\t\t\t\taddresses.pop();\n\t\t\t}\n\t\t\tuni.setStorageSync(STORAGE_KEYS.USER_ADDRESSES, addresses);\n\t\t}\n\t},\n\t\n\t/**\n\t * 获取所有常用地址\n\t * @returns {Array}\n\t */\n\tgetAll: () => {\n\t\ttry {\n\t\t\treturn uni.getStorageSync(STORAGE_KEYS.USER_ADDRESSES) || [];\n\t\t} catch (e) {\n\t\t\treturn [];\n\t\t}\n\t}\n};\n\n/**\n * 订单摘要管理\n */\nconst recentOrders = {\n\t/**\n\t * 保存订单摘要（用于离线查看）\n\t * @param {Object} orderSummary 订单摘要\n\t */\n\tsave: (orderSummary) => {\n\t\tconst orders = recentOrders.getAll();\n\t\tconst exists = orders.find(o => o.order_id === orderSummary.order_id);\n\t\t\n\t\tif (exists) {\n\t\t\t// 更新\n\t\t\tconst index = orders.findIndex(o => o.order_id === orderSummary.order_id);\n\t\t\torders[index] = {\n\t\t\t\t...orderSummary,\n\t\t\t\tupdated_at: Date.now()\n\t\t\t};\n\t\t} else {\n\t\t\t// 新增\n\t\t\torders.unshift({\n\t\t\t\t...orderSummary,\n\t\t\t\tcreated_at: Date.now(),\n\t\t\t\tupdated_at: Date.now()\n\t\t\t});\n\t\t\t// 最多保存 50 条\n\t\t\tif (orders.length > 50) {\n\t\t\t\torders.pop();\n\t\t\t}\n\t\t}\n\t\t\n\t\tuni.setStorageSync(STORAGE_KEYS.RECENT_ORDERS, orders);\n\t},\n\t\n\t/**\n\t * 获取所有订单摘要\n\t * @returns {Array}\n\t */\n\tgetAll: () => {\n\t\ttry {\n\t\t\treturn uni.getStorageSync(STORAGE_KEYS.RECENT_ORDERS) || [];\n\t\t} catch (e) {\n\t\t\treturn [];\n\t\t}\n\t}\n};\n\n/**\n * 自动同步功能\n * 当网络从无到有时，自动尝试同步本地草稿\n */\nlet networkStatus = 'unknown';\nlet syncTimer = null;\n\nconst startNetworkMonitor = () => {\n\t// 监听网络状态变化\n\tuni.onNetworkStatusChange((res) => {\n\t\tconst wasOffline = networkStatus === 'none' || networkStatus === 'unknown';\n\t\tconst isOnline = res.isConnected && res.networkType !== 'none';\n\t\t\n\t\tif (wasOffline && isOnline) {\n\t\t\t// 网络从无到有，触发同步\n\t\t\ttriggerSync();\n\t\t}\n\t\t\n\t\tnetworkStatus = res.networkType;\n\t});\n\t\n\t// 初始化网络状态\n\tuni.getNetworkType({\n\t\tsuccess: (res) => {\n\t\t\tnetworkStatus = res.networkType;\n\t\t}\n\t});\n};\n\n/**\n * 触发同步\n */\nconst triggerSync = async () => {\n\tconst queue = syncQueue.getAll();\n\tif (queue.length === 0) {\n\t\treturn;\n\t}\n\t\n\t// 使用 require 方式导入 request（避免循环依赖）\n\tlet request;\n\ttry {\n\t\trequest = require('./request.js').default;\n\t} catch (e) {\n\t\tconsole.error('导入 request 失败', e);\n\t\treturn;\n\t}\n\t\n\tfor (const item of queue) {\n\t\ttry {\n\t\t\tconst draft = draftDemand.getById(item.local_id);\n\t\t\tif (!draft) {\n\t\t\t\tsyncQueue.remove(item.local_id);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t\n\t\t\t// 调用同步接口\n\t\t\tconst result = await request.post('/api/demand/sync', draft);\n\t\t\t\n\t\t\t// 同步成功，移除队列和草稿\n\t\t\tsyncQueue.remove(item.local_id);\n\t\t\tdraftDemand.remove(item.local_id);\n\t\t\t\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '草稿同步成功',\n\t\t\t\ticon: 'success'\n\t\t\t});\n\t\t} catch (error) {\n\t\t\t// 同步失败，增加重试次数\n\t\t\tsyncQueue.incrementRetry(item.local_id);\n\t\t\tconsole.error('同步失败', error);\n\t\t}\n\t}\n};\n\n// 启动网络监听\nstartNetworkMonitor();\n\nexport default {\n\tdraftDemand,\n\tsyncQueue,\n\tuserAddress,\n\trecentOrders,\n\ttriggerSync,\n\tgenerateLocalId\n};\n\n"],"names":["uni","item"],"mappings":"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"}